
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://microsoft.github.io/agent-lightning/latest/algorithm-zoo/verl/">
      
      
        <link rel="prev" href="../apo/">
      
      
        <link rel="next" href="../../deep-dive/birds-eye-view/">
      
      
      <link rel="icon" href="../../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>VERL - Agent Lightning</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="agl" data-md-color-accent="agl">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#verl" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Agent Lightning" class="md-header__button md-logo" aria-label="Agent Lightning" data-md-component="logo">
      
  <img src="../../assets/favicon-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Agent Lightning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              VERL
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="agl" data-md-color-accent="agl"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="agl" data-md-color-accent="agl"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/agent-lightning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agent-lightning
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Agent Lightning" class="md-nav__button md-logo" aria-label="Agent Lightning" data-md-component="logo">
      
  <img src="../../assets/favicon-white.svg" alt="logo">

    </a>
    Agent Lightning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/agent-lightning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agent-lightning
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Quickstart
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/train-first-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train the First Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/write-first-algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Write the First Algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    How-To Recipes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            How-To Recipes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/unsloth-sft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SFT with Unsloth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/train-sql-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train SQL Agent with RL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Learning More
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Learning More
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/write-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Write Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/parallelize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parallelize
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Algorithm Zoo
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Algorithm Zoo
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../apo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    APO
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    VERL
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    VERL
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customization" class="md-nav__link">
    <span class="md-ellipsis">
      Customization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorials-using-verl" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorials Using VERL
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-entrypoint" class="md-nav__link">
    <span class="md-ellipsis">
      References - Entrypoint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agentlightning.algorithm.verl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;verl
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" verl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.verl.VERL" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;VERL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      References - Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agentlightning.verl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;verl
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" verl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentLightningTrainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentModeDaemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AgentModeDaemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;clear_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_test_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_test_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_train_data_batch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run_until_all_finished
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_up_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_left_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_left_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_right_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_right_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Deep Dive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Deep Dive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/birds-eye-view/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bird's Eye View
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/tracing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding Tracing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Line
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/instrumentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instrumentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/trainer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trainer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Types
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    <span class="md-ellipsis">
      Installation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    <span class="md-ellipsis">
      Resources
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customization" class="md-nav__link">
    <span class="md-ellipsis">
      Customization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorials-using-verl" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorials Using VERL
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-entrypoint" class="md-nav__link">
    <span class="md-ellipsis">
      References - Entrypoint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agentlightning.algorithm.verl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;verl
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" verl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.algorithm.verl.VERL" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;VERL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      References - Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agentlightning.verl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;verl
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" verl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentLightningTrainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentModeDaemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AgentModeDaemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;clear_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_test_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_test_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_train_data_batch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run_until_all_finished
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_up_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_left_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_left_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_right_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_right_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
  <div id="version-warning" class="version-warning" style="display: none;">
    ⚠️ You are viewing development documentation. For stable documentation, please visit
    <a href="https://microsoft.github.io/agent-lightning/stable/">https://microsoft.github.io/agent-lightning/stable/</a>
  </div>
  
                  


  
  


<h1 id="verl">VERL<a class="headerlink" href="#verl" title="Permanent link">&para;</a></h1>
<div class="admonition tip">
<p class="admonition-title">Shortcut</p>
<p>You can use the shortcut <code>agl.VERL(...)</code> to create a VERL instance.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">agentlightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">agl</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">agl</span><span class="o">.</span><span class="n">VERL</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>pip<span class="w"> </span>install<span class="w"> </span>agentlightning<span class="o">[</span>verl<span class="o">]</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To avoid various compatibility issues, follow the steps in the <a href="../../tutorials/installation/">installation guide</a> to set up VERL and its dependencies. Installing VERL directly with <code>pip install agentlightning[verl]</code> can cause issues unless you already have a compatible version of PyTorch installed.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Notes for Readers</p>
<p><a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> in this article refers to a wrapper, provided by Agent-lightning, of the VERL framework. It's a subclass of <a class="autorefs autorefs-internal" title="            agentlightning.Algorithm" href="../../reference/algorithm/#agentlightning.Algorithm">agentlightning.Algorithm</a>. To differentiate it from the VERL framework, all references to the VERL framework shall use the term "VERL framework", and all references to the Agent-lightning wrapper shall be highlighted with a link.</p>
</div>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<p><a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> expects no initial resources. The first LLM endpoint is directly deployed from the VERL configuration (<code>.actor_rollout_ref.model.path</code>). The resource key is always <code>main_llm</code>.</p>
<p><a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> currently does not support optimizing multiple <a class="autorefs autorefs-internal" title="            agentlightning.LLM" href="../../reference/types/#agentlightning.LLM">LLM</a>s together.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The resource type created by <a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> is actually a <a class="autorefs autorefs-internal" title="            agentlightning.ProxyLLM" href="../../reference/types/#agentlightning.ProxyLLM">ProxyLLM</a>, a subclass of the <a class="autorefs autorefs-internal" title="            agentlightning.LLM" href="../../reference/types/#agentlightning.LLM">LLM</a> type. This object contains a <strong>URL template</strong> provided by <a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a>, with placeholders for rollout and attempt IDs. When a rollout begins on the agent side, the framework uses the current <code>rollout_id</code> and <code>attempt_id</code> to format this template, generating a final, unique endpoint URL. This URL points to <a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a>'s internal proxy, allowing it to intercept and log all traffic for that specific attempt, for tracing and load balancing purposes. For agents created with the <code>@rollout</code> decorator, this resolution of the template is handled automatically ("auto-stripped"). Class-based agents will need to manually resolve the <code>ProxyLLM</code> using the rollout context.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">proxy_llm</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;main_llm&quot;</span><span class="p">]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">proxy_llm</span><span class="o">.</span><span class="n">get_base_url</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span><span class="o">.</span><span class="n">attempt</span><span class="o">.</span><span class="n">attempt_id</span><span class="p">)</span>
</code></pre></div>
</div>
<h2 id="customization">Customization<a class="headerlink" href="#customization" title="Permanent link">&para;</a></h2>
<p>Internally, <a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> decomposes each agent execution into prompt–response pairs via the <a class="autorefs autorefs-internal" title="            agentlightning.Adapter" href="../../reference/algorithm/#agentlightning.Adapter">Adapter</a> and associates them with their corresponding reward signals as <a class="autorefs autorefs-internal" title="            agentlightning.Triplet" href="../../reference/types/#agentlightning.Triplet">Triplet</a> objects. The final scalar reward, derived from the last triplet in the trajectory, is propagated to all preceding triplets following the <a href="https://arxiv.org/abs/2508.03680">identical assignment strategy</a>. This ensures that each triplet receives an identical reward signal and can be independently optimized as a valid RLHF trajectory within the VERL framework.</p>
<p>At present, <a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> does not expose fine-grained control over its reward propagation or credit assignment mechanisms. Users requiring customized reward shaping or trajectory decomposition are advised to clone and modify the <a class="autorefs autorefs-internal" title="            VERL" href="#agentlightning.algorithm.verl.VERL">VERL</a> source implementation directly.</p>
<h2 id="tutorials-using-verl">Tutorials Using VERL<a class="headerlink" href="#tutorials-using-verl" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../../how-to/train-sql-agent/">Train SQL Agent with RL</a> - A practical example of training a SQL agent using VERL.</li>
</ul>
<h2 id="references-entrypoint">References - Entrypoint<a class="headerlink" href="#references-entrypoint" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<h2 id="agentlightning.algorithm.verl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>agentlightning.algorithm.verl</code>


<a href="#agentlightning.algorithm.verl" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="agentlightning.algorithm.verl.VERL" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>VERL</code>


<a href="#agentlightning.algorithm.verl.VERL" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            agentlightning.Algorithm (agentlightning.algorithm.base.Algorithm)" href="../../reference/algorithm/#agentlightning.Algorithm">Algorithm</a></code></p>


        <p>Algorithm leveraging VERL as the backend framework.</p>
<p><strong>Note on Customization:</strong></p>
<p>At present, we recommend copying the source code from VERL and modifying it as needed to suit your requirements.
Native support for customizing training logic will be provided in future releases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The VERL configuration, matching what is typically provided when running VERL via the command line.
This config will be merged with VERL's base configuration and processed by Hydra.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>agentlightning/algorithm/verl/interface.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">VERL</span><span class="p">(</span><span class="n">Algorithm</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Algorithm leveraging VERL as the backend framework.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    **Note on Customization:**</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    At present, we recommend copying the source code from VERL and modifying it as needed to suit your requirements.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    Native support for customizing training logic will be provided in future releases.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        config: The VERL configuration, matching what is typically provided when running VERL via the command line.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            This config will be merged with VERL&#39;s base configuration and processed by Hydra.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="c1"># Compose the base config exactly like your decorator:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="k">with</span> <span class="n">initialize</span><span class="p">(</span><span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;pkg://agentlightning/verl&quot;</span><span class="p">):</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="n">base_cfg</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="c1"># Merge your dict overrides</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">override_conf</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">base_cfg</span><span class="p">,</span> <span class="n">override_conf</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">val_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_store</span><span class="p">()</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Store is not set. Assuming v0 execution mode.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">run_ppo</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="n">val_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="n">store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="n">llm_proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="n">adapter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Store is set. Assuming v1 execution mode.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">llm_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_llm_proxy</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">adapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adapter</span><span class="p">()</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">run_ppo</span><span class="p">(</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="n">val_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="n">llm_proxy</span><span class="o">=</span><span class="n">llm_proxy</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="n">adapter</span><span class="o">=</span><span class="n">adapter</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentLightningClient</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">agentlightning</span><span class="o">.</span><span class="n">port</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">return</span> <span class="n">AgentLightningClient</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="references-implementation">References - Implementation<a class="headerlink" href="#references-implementation" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<h2 id="agentlightning.verl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>agentlightning.verl</code>


<a href="#agentlightning.verl" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">

        <p>This package contains a <em>hacky</em> integration of VERL with Agent Lightning.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.AgentLightningTrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>AgentLightningTrainer</code>


<a href="#agentlightning.verl.AgentLightningTrainer" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="verl.trainer.ppo.ray_trainer.RayPPOTrainer">RayPPOTrainer</span></code></p>


        <p>Specialized PPO trainer for agent-based reinforcement learning.</p>
<p>This trainer is designed specifically for scenarios where the model interacts with
external environments, tools, or APIs through an AgentLightningServer. It simplifies
the training loop by removing the complex conditional logic present in the original
RayPPOTrainer and focusing on the agent mode workflow.</p>
<p>Key differences from RayPPOTrainer:
1. Uses AgentModeDaemon for server communication
2. Simplified data flow without pop/union operations
3. Direct batch processing through agent daemon
4. Streamlined validation using agent_mode validation</p>








              <details class="quote">
                <summary>Source code in <code>agentlightning/verl/trainer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentLightningTrainer</span><span class="p">(</span><span class="n">RayPPOTrainer</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Specialized PPO trainer for agent-based reinforcement learning.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    This trainer is designed specifically for scenarios where the model interacts with</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    external environments, tools, or APIs through an AgentLightningServer. It simplifies</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    the training loop by removing the complex conditional logic present in the original</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    RayPPOTrainer and focusing on the agent mode workflow.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Key differences from RayPPOTrainer:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    1. Uses AgentModeDaemon for server communication</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    2. Simplified data flow without pop/union operations</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    3. Direct batch processing through agent daemon</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    4. Streamlined validation using agent_mode validation</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">LightningStore</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">llm_proxy</span><span class="p">:</span> <span class="n">LLMProxy</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">adapter</span><span class="p">:</span> <span class="n">TraceAdapter</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="p">):</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span> <span class="o">=</span> <span class="n">llm_proxy</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Please set val_batch_size to None for better throughput.&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">test_data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">))</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">test_batch</span> <span class="o">=</span> <span class="n">DataProto</span><span class="o">.</span><span class="n">from_single_dict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">wake_up</span><span class="p">()</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">set_up_data_and_server</span><span class="p">(</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="n">test_batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">,</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">server_addresses</span><span class="p">,</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">run_until_all_finished</span><span class="p">()</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">test_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">get_test_metrics</span><span class="p">()</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">clear_data_and_server</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">return</span> <span class="n">test_metrics</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="c1"># Isolate in a separate method to automatically recycle the variables before validation.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">DataProto</span> <span class="o">=</span> <span class="n">DataProto</span><span class="o">.</span><span class="n">from_single_dict</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">timing_raw</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="c1"># When agent mode is enabled, we read the batch as it is.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">gen_batch</span> <span class="o">=</span> <span class="n">batch</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="c1"># generate a batch</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;gen&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">wake_up</span><span class="p">()</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">set_up_data_and_server</span><span class="p">(</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                    <span class="n">gen_batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">server_addresses</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">run_until_all_finished</span><span class="p">()</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">batch</span><span class="p">,</span> <span class="n">agent_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">get_train_data_batch</span><span class="p">(</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="n">max_prompt_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="n">max_response_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="n">device</span><span class="o">=</span><span class="n">gen_batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;fake_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">agent_metrics</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">clear_data_and_server</span><span class="p">()</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">adv_estimator</span> <span class="o">==</span> <span class="n">AdvantageEstimator</span><span class="o">.</span><span class="n">REMAX</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;gen_max&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                    <span class="n">gen_baseline_batch</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">gen_batch</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">gen_baseline_batch</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;do_sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="n">gen_baseline_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">generate_sequences</span><span class="p">(</span><span class="n">gen_baseline_batch</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">gen_baseline_output</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                    <span class="n">reward_baseline_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                    <span class="n">reward_baseline_tensor</span> <span class="o">=</span> <span class="n">reward_baseline_tensor</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">batch_keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">gen_baseline_output</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reward_baselines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_baseline_tensor</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="k">del</span> <span class="n">gen_baseline_batch</span><span class="p">,</span> <span class="n">gen_baseline_output</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="c1"># uid is used for algorithm like GRPO, should be aligned to data id</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;data_id_list&quot;</span><span class="p">]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;response_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_response_mask</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="c1"># compute global_valid tokens</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;global_token_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;reward&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="c1"># compute reward model score</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rm</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                    <span class="n">reward_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_wg</span><span class="o">.</span><span class="n">compute_rm_score</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">reward_tensor</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="n">reward_extra_infos_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="c1"># for agent mode, pad the lengths to calculate old log prob, ref, and values</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">batch</span><span class="p">,</span> <span class="n">pad_size</span> <span class="o">=</span> <span class="n">pad_dataproto_to_divisor</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">world_size</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="c1"># recompute old_log_probs</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;old_log_prob&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="n">old_log_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">compute_log_prob</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="n">entropys</span> <span class="o">=</span> <span class="n">old_log_prob</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entropys&quot;</span><span class="p">]</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="n">response_masks</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;response_mask&quot;</span><span class="p">]</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">loss_agg_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">loss_agg_mode</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">entropy_loss</span> <span class="o">=</span> <span class="n">agg_loss</span><span class="p">(</span><span class="n">loss_mat</span><span class="o">=</span><span class="n">entropys</span><span class="p">,</span> <span class="n">loss_mask</span><span class="o">=</span><span class="n">response_masks</span><span class="p">,</span> <span class="n">loss_agg_mode</span><span class="o">=</span><span class="n">loss_agg_mode</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">old_log_prob_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;actor/entropy_loss&quot;</span><span class="p">:</span> <span class="n">entropy_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_log_prob_metrics</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">old_log_prob</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;entropys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">old_log_prob</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_reference_policy</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="c1"># compute reference log_prob</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="n">ref_log_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_policy_wg</span><span class="o">.</span><span class="n">compute_ref_log_prob</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ref_log_prob</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="c1"># compute values</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_critic</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic_wg</span><span class="o">.</span><span class="n">compute_values</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="c1"># for agent mode, unpad to calculate adv</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="c1"># it is important, as adv should be based on the raw traces</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">unpad_dataproto</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pad_size</span><span class="o">=</span><span class="n">pad_size</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;adv&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="c1"># if agent_mode is enabled, there is already token_level_scores</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="c1"># token_level_scores is not needed to compute here</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="c1"># compute rewards. apply_kl_penalty if available</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">use_kl_in_reward</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="n">batch</span><span class="p">,</span> <span class="n">kl_metrics</span> <span class="o">=</span> <span class="n">apply_kl_penalty</span><span class="p">(</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                        <span class="n">batch</span><span class="p">,</span> <span class="n">kl_ctrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_ctrl_in_reward</span><span class="p">,</span> <span class="n">kl_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">kl_penalty</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kl_metrics</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_level_rewards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_level_scores&quot;</span><span class="p">]</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                <span class="c1"># compute advantages, executed on the driver process</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="n">norm_adv_by_std_in_grpo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="s2">&quot;norm_adv_by_std_in_grpo&quot;</span><span class="p">,</span> <span class="kc">True</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="p">)</span>  <span class="c1"># GRPO adv normalization factor</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="n">compute_advantage</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">batch</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">adv_estimator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">adv_estimator</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="n">lam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="n">num_repeat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                    <span class="n">norm_adv_by_std_in_grpo</span><span class="o">=</span><span class="n">norm_adv_by_std_in_grpo</span><span class="p">,</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">,</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="c1"># after advantages are assinged, we begin to drop (1) long prompt (2) floor to ppo minisize</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">keep_indices</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;is_drop_mask&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;training/n_triplets_prompt_too_long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;is_drop_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">keep_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="c1"># next, round to minibatch size</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">mini_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ppo_mini_batch_size</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">n_transition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">random_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_transition</span><span class="p">))</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">random_indices</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">random_indices</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="n">n_remained_transition</span> <span class="o">=</span> <span class="n">n_transition</span> <span class="o">//</span> <span class="n">mini_batch_size</span> <span class="o">*</span> <span class="n">mini_batch_size</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_remained_transition</span><span class="p">))]</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;training/n_triplets_dropped_remainder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_transition</span> <span class="o">-</span> <span class="n">n_remained_transition</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="c1"># Agent mode note: Change the order of balance batch;</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="c1">#     1. first calculate advantage</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="c1">#     2. then drop the samples (too long prompt &amp; floor to ppo minisize)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="c1">#     3. balance</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="c1"># balance the number of valid tokens on each dp rank.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="c1"># Note that this breaks the order of data inside the batch.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="c1"># Please take care when you implement group based adv computation such as GRPO and rloo</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">balance_batch</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_balance_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="c1"># update critic</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_critic</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;update_critic&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="n">critic_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic_wg</span><span class="o">.</span><span class="n">update_critic</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="n">critic_output_metrics</span> <span class="o">=</span> <span class="n">reduce_metrics</span><span class="p">(</span><span class="n">critic_output</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">critic_output_metrics</span><span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="c1"># implement critic warmup</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">critic_warmup</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="c1"># update actor</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;update_actor&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;multi_turn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">multi_turn</span><span class="o">.</span><span class="n">enable</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                    <span class="n">actor_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">update_actor</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">actor_output_metrics</span> <span class="o">=</span> <span class="n">reduce_metrics</span><span class="p">(</span><span class="n">actor_output</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">actor_output_metrics</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="c1"># Log rollout generations if enabled</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">rollout_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rollout_data_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="k">if</span> <span class="n">rollout_data_dir</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;dump_rollout_generations&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                    <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                    <span class="n">scores</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_level_scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_generations</span><span class="p">(</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                        <span class="n">scores</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                        <span class="n">reward_extra_infos_dict</span><span class="o">=</span><span class="n">reward_extra_infos_dict</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                        <span class="n">dump_path</span><span class="o">=</span><span class="n">rollout_data_dir</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                    <span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="c1"># compute training metrics</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compute_data_metrics</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">use_critic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_critic</span><span class="p">))</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compute_timing_metrics</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">timing_raw</span><span class="o">=</span><span class="n">timing_raw</span><span class="p">))</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="c1"># TODO: implement actual tflpo and theoretical tflpo</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">n_gpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_pool_manager</span><span class="o">.</span><span class="n">get_n_gpus</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compute_throughout_metrics</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">timing_raw</span><span class="o">=</span><span class="n">timing_raw</span><span class="p">,</span> <span class="n">n_gpus</span><span class="o">=</span><span class="n">n_gpus</span><span class="p">))</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="k">return</span> <span class="n">metrics</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">Tracking</span><span class="p">(</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="n">project_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="n">experiment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="n">default_backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">config</span><span class="o">=</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">resolve</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="c1"># load checkpoint before doing anything</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_checkpoint</span><span class="p">()</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_mode</span><span class="p">,</span> <span class="s2">&quot;If agent mode is enabled, async server must be enabled&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="p">,</span> <span class="n">TraceToTripletBase</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Adapter must be a TraceToTripletBase for currently VERL implementation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span> <span class="o">=</span> <span class="n">AgentModeDaemon</span><span class="p">(</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">agentlightning</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">train_information</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="c1"># Note (Zhiyuan): To avoid further patch into vllm async server, using the same sentence to get the naming here.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                <span class="c1"># However, it is possible that verl updates the naming and causes incompatibility.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                <span class="c1"># Reference: https://github.com/volcengine/verl/blob/5b5e09d9cc20625e436d01f69d9cc739ff681c54/verl/workers/rollout/vllm_rollout/vllm_async_server.py#L217</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]),</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="p">},</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">mini_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ppo_mini_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;v0&quot;</span><span class="p">,</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="n">store</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">,</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="n">llm_proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="p">,</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="n">adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="p">,</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="c1"># perform validation before training</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="c1"># currently, we only support validation using the reward_function.</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_reward_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val_before_train&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">val_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="k">assert</span> <span class="n">val_metrics</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_metrics</span><span class="si">=}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial validation metrics: </span><span class="si">{</span><span class="n">val_metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">val_metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                <span class="k">return</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="c1"># add tqdm</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_training_steps</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training Progress&quot;</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="c1"># we start from step 1</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">last_val_metrics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">total_epochs</span><span class="p">):</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="k">for</span> <span class="n">batch_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="n">timing_raw</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                <span class="n">is_last_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_training_steps</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="c1"># train step</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_step</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="c1"># validate</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">val_reward_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">test_freq</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                    <span class="ow">and</span> <span class="p">(</span><span class="n">is_last_step</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">test_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="p">):</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                    <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                        <span class="n">val_metrics</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                        <span class="k">if</span> <span class="n">is_last_step</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                            <span class="n">last_val_metrics</span> <span class="o">=</span> <span class="n">val_metrics</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                    <span class="n">is_last_step</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="p">):</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                    <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;save_checkpoint&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">()</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                <span class="c1"># step metrics</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                    <span class="p">{</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                        <span class="s2">&quot;training/global_step&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                        <span class="s2">&quot;training/epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                    <span class="p">}</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                <span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                <span class="c1"># TODO: make a canonical logger that supports various backend</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                <span class="k">if</span> <span class="n">is_last_step</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final validation metrics: </span><span class="si">{</span><span class="n">last_val_metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                    <span class="c1"># This exit logic is to ensure a robust CI.</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flush the logger...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                    <span class="k">del</span> <span class="n">logger</span>  <span class="c1"># Make sure the loggers are flushed and closed properly</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training finished at step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                    <span class="k">return</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.AgentModeDaemon" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>AgentModeDaemon</code>


<a href="#agentlightning.verl.AgentModeDaemon" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>AgentModeDaemon using the AgentLightningServer SDK.</p>
<p>This class manages the server lifecycle, task queueing, and results
retrieval, while also running a proxy server for LLM requests. It maintains
the original interface for compatibility with the RayPPOTrainer.</p>








              <details class="quote">
                <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentModeDaemon</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    AgentModeDaemon using the AgentLightningServer SDK.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">    This class manages the server lifecycle, task queueing, and results</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">    retrieval, while also running a proxy server for LLM requests. It maintains</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    the original interface for compatibility with the RayPPOTrainer.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">train_rollout_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">train_information</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">mini_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">reward_fillna_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">llm_timeout_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1200.0</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;v0&quot;</span><span class="p">,</span> <span class="s2">&quot;v1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">llm_proxy</span><span class="p">:</span> <span class="n">LLMProxy</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">store</span><span class="p">:</span> <span class="n">LightningStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">adapter</span><span class="p">:</span> <span class="n">TraceToTripletBase</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span> <span class="o">=</span> <span class="n">llm_timeout_seconds</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="c1"># Server and Task Configuration</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="k">assert</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">AgentLightningServer</span><span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">,</span> <span class="n">task_timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span> <span class="o">=</span> <span class="n">_find_available_port</span><span class="p">()</span>  <span class="c1"># Run proxy on a different port</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="k">assert</span> <span class="n">store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="k">if</span> <span class="n">llm_proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span> <span class="o">=</span> <span class="n">LLMProxy</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">port</span><span class="o">=</span><span class="n">_find_available_port</span><span class="p">(),</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                    <span class="n">model_list</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="c1"># Reuse the existing LLM proxy (probably configured by user)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span> <span class="o">=</span> <span class="n">llm_proxy</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="k">if</span> <span class="n">adapter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">TracerTraceToTriplet</span><span class="p">()</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="c1"># Reuse the one from trainer</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop_runner</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="c1"># Training and Data Configuration</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_rollout_n</span> <span class="o">=</span> <span class="n">train_rollout_n</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_information</span> <span class="o">=</span> <span class="n">train_information</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="n">mini_batch_size</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">pad_token_id</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span> <span class="o">=</span> <span class="n">reward_fillna_value</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="c1"># Internal State</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RolloutLegacy</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_internal_loop_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the internal loop.&quot;&quot;&quot;</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span> <span class="o">=</span> <span class="n">loop</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_start_proxy_server_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        Initializes and runs a Flask-based proxy server in a separate thread.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        This proxy load-balances requests to the actual backend LLM servers.</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="n">num_requests</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="n">last_request_time</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/v1/&lt;path:path&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">])</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">proxy</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="n">abort</span><span class="p">(</span><span class="mi">503</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No backend LLM servers available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># Randomly choose a backend server for load balancing</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">target_server</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">target_server</span><span class="si">}</span><span class="s2">/v1/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="c1"># Copy client request headers, removing the Host header</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;host&quot;</span><span class="p">}</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="c1"># Log the request for debugging</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">nonlocal</span> <span class="n">num_requests</span><span class="p">,</span> <span class="n">last_request_time</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="n">num_requests</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_request_time</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">or</span> <span class="n">num_requests</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">num_requests</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxying </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> request to </span><span class="si">{</span><span class="n">target_server</span><span class="si">}</span><span class="s2">. Request data: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="n">last_request_time</span> <span class="o">=</span> <span class="n">current_time</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="c1"># Forward the request to the target backend</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                    <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="n">params</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="n">cookies</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="c1"># Filter out hop-by-hop headers before returning the response</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="n">excluded_headers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                    <span class="s2">&quot;content-encoding&quot;</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                    <span class="s2">&quot;content-length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                    <span class="s2">&quot;transfer-encoding&quot;</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                    <span class="s2">&quot;connection&quot;</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                    <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                    <span class="s2">&quot;proxy-authenticate&quot;</span><span class="p">,</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                    <span class="s2">&quot;proxy-authorization&quot;</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="s2">&quot;te&quot;</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                    <span class="s2">&quot;trailers&quot;</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                    <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="p">]</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_headers</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="p">]</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                    <span class="c1"># NOTE: from Zhiyuan&#39;s code.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                    <span class="c1"># https://github.com/hzy46/verl_agent_mode/blob/2db65ea9858f645a914120357412a7540f8bd82d/verl/trainer/ppo/ray_trainer.py#L692-L711</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                    <span class="c1"># request_json = json.loads(request.get_data().decode(&quot;utf-8&quot;))</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                    <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                    <span class="c1"># response_message = ChatCompletion(**response_json).choices[0].message.model_dump(exclude_unset=True, exclude_none=True)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                    <span class="c1"># tool_schemas = request_json.get(&quot;tools&quot;, None)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                    <span class="c1"># prompt_ids = self.tokenizer.apply_chat_template(request_json[&quot;messages&quot;], tools=tool_schemas, add_generation_prompt=True, tokenize=True)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                    <span class="c1"># full_ids = self.tokenizer.apply_chat_template(request_json[&quot;messages&quot;] + [response_message], tools=tool_schemas, add_generation_prompt=False, tokenize=True)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                    <span class="c1"># TBD: response_ids sometimes ends with &quot;&lt;eos_id&gt;\n&quot;, shall we keep the extra &quot;\n&quot;?</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                    <span class="c1"># sometimes it has some differences with the hacky method in the end, but this should align with ToolCompletionCallback</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                    <span class="c1"># response_ids = full_ids[len(prompt_ids):]</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                    <span class="c1"># NOTE (yuge): They are different. Don&#39;t know why.</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="c1"># assert response_json[&#39;prompt_token_ids&#39;] == prompt_ids</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="c1"># patched_response_ids = response_json[&#39;response_token_ids&#39;][0]</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="c1"># assert patched_response_ids == response_ids[:len(patched_response_ids)], f&quot;{patched_response_ids} != {response_ids[:len(patched_response_ids)]}&quot;</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="c1"># response_json[&#39;prompt_token_ids&#39;] = prompt_ids</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="c1"># response_json[&#39;response_token_ids&#39;] = [response_ids]</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                    <span class="n">replaced_return_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">replaced_return_content</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">response_headers</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error proxying request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">run_app</span><span class="p">():</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_app</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy server running on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_proxy_server_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_information</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_name</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model name is not set.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="o">.</span><span class="n">update_model_list</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="p">[</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="n">ModelConfig</span><span class="p">(</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="p">{</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                        <span class="s2">&quot;litellm_params&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;hosted_vllm/&quot;</span> <span class="o">+</span> <span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                            <span class="s2">&quot;api_base&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">/v1/&quot;</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                        <span class="p">},</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                    <span class="p">}</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="p">],</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="c1"># FIXME: Need to switch to a different port right now</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="c1"># because the forked processes carried the old fd</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="n">_port</span><span class="o">=</span><span class="n">_find_available_port</span><span class="p">())</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the main AgentLightningServer and the proxy server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">run_server</span><span class="p">():</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="w">                </span><span class="sd">&quot;&quot;&quot;Run the AgentLightningServer in a separate thread.&quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">run_forever</span><span class="p">())</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="c1"># Wait for the server&#39;s internal startup event to be set.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for AgentLightningServer to start...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>  <span class="c1"># Wait up to 20s</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ready</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AgentLightningServer failed to start within the timeout period.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AgentLightningServer control plane running on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_start_proxy_server_v0</span><span class="p">()</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="c1"># Agent lightning server is no longer needed;</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="c1"># Start proxy server in _async_set_up</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="k">pass</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_set_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">server_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async helper to set up data and resources on the server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_data_and_server</span><span class="p">()</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">if</span> <span class="n">server_addresses</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">:</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span> <span class="o">=</span> <span class="n">server_addresses</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v1&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_proxy_server_v1</span><span class="p">()</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="c1"># 1. Update resources on the server for clients to use</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="n">llm_resource</span> <span class="o">=</span> <span class="n">LLM</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                <span class="n">endpoint</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://127.0.0.1:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="si">}</span><span class="s2">/v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_information</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;default-model&quot;</span><span class="p">),</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>                <span class="n">sampling_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_information</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.7</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                <span class="p">},</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="n">llm_resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_proxy</span><span class="o">.</span><span class="n">as_resource</span><span class="p">(</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                <span class="n">sampling_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_information</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.7</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                <span class="p">},</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">resources</span><span class="p">:</span> <span class="n">NamedResources</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main_llm&quot;</span><span class="p">:</span> <span class="n">llm_resource</span><span class="p">}</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="n">resources_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="n">resources_update</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">add_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="n">resources_id</span> <span class="o">=</span> <span class="n">resources_update</span><span class="o">.</span><span class="n">resources_id</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="c1"># 2. Queue tasks for agents to process</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="n">rollouts_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_rollout_n</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mi">1</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="n">data_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">original_sample</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">original_sample</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_id</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="c1"># For training, each sample is rolled out multiple times</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rollouts_per_sample</span><span class="p">):</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                <span class="n">task_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data_id&quot;</span><span class="p">:</span> <span class="n">data_id</span><span class="p">,</span> <span class="s2">&quot;is_train&quot;</span><span class="p">:</span> <span class="n">is_train</span><span class="p">}</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                <span class="c1"># Data ID is different from Rollout ID, as one data can have multiple rollouts.</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                    <span class="n">rollout_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">queue_task</span><span class="p">(</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                        <span class="n">sample</span><span class="o">=</span><span class="n">_to_native</span><span class="p">(</span><span class="n">original_sample</span><span class="p">),</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                        <span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                        <span class="n">metadata</span><span class="o">=</span><span class="n">task_metadata</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                    <span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                    <span class="n">rollout</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">enqueue_rollout</span><span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                        <span class="nb">input</span><span class="o">=</span><span class="n">_to_native</span><span class="p">(</span><span class="n">original_sample</span><span class="p">),</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                        <span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                        <span class="n">metadata</span><span class="o">=</span><span class="n">task_metadata</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                    <span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">update_rollout</span><span class="p">(</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                        <span class="n">rollout_id</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                        <span class="n">config</span><span class="o">=</span><span class="n">RolloutConfig</span><span class="p">(</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                            <span class="n">unresponsive_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span><span class="p">,</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                            <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span><span class="p">,</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                        <span class="p">),</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                    <span class="p">)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                    <span class="n">rollout_id</span> <span class="o">=</span> <span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="c1"># Store original sample data to reconstruct batch information later</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_sample</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_up_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">server_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronous wrapper for setting up data and server resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_set_up</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal loop is not running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Wait for completion with a timeout</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to set up data on server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="k">raise</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout</span><span class="p">:</span> <span class="n">RolloutLegacy</span><span class="p">):</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">final_reward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                <span class="sa">f</span><span class="s2">&quot;Warning: Reward is None for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, will be auto-set to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="p">)</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Triplet is None for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Length of triplets is 0 for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">):</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> contains empty response: </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">):</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> contains empty prompt: </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_validate_data_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout</span><span class="p">:</span> <span class="n">Rollout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RolloutLegacy</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert Rollout to RolloutLegacy and validate.</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="sd">        1. Task: construct from Rollout</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">        2. Triplets: obtained by querying spans and feeding into the adapter</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">        3. Final reward: extracted from last triplet&#39;s reward, searching backwards if not found</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="c1"># Query spans for this rollout (latest attempt)</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="n">spans</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">query_spans</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">,</span> <span class="n">attempt_id</span><span class="o">=</span><span class="s2">&quot;latest&quot;</span><span class="p">)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="c1"># Convert spans to triplets using the adapter</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">spans</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="c1"># No triplets found, will emit a warning later.</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="n">triplets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>            <span class="n">triplets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapter</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="c1"># Extract final reward from triplets</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">final_reward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="k">if</span> <span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="c1"># Search backwards through triplets for the first non-None reward</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="k">for</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">triplets</span><span class="p">):</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                <span class="k">if</span> <span class="n">triplet</span><span class="o">.</span><span class="n">reward</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                    <span class="n">final_reward</span> <span class="o">=</span> <span class="n">triplet</span><span class="o">.</span><span class="n">reward</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                    <span class="k">break</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="c1"># Construct the Task object from Rollout</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">rollout_id</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">,</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="nb">input</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">mode</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>            <span class="n">resources_id</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">resources_id</span><span class="p">,</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="n">metadata</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="c1"># Create the Rollout object (without trace and logs as per user&#39;s note)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="n">result_rollout</span> <span class="o">=</span> <span class="n">RolloutLegacy</span><span class="p">(</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>            <span class="n">rollout_id</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">,</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>            <span class="n">final_reward</span><span class="o">=</span><span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="n">triplets</span><span class="o">=</span><span class="n">triplets</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>            <span class="n">metadata</span><span class="o">=</span><span class="n">rollout</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="c1"># Run the same validation as v0</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span><span class="n">result_rollout</span><span class="p">)</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="k">return</span> <span class="n">result_rollout</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_run_until_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async helper to wait for all tasks to complete.&quot;&quot;&quot;</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="n">completed_batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">retrieve_completed_rollouts</span><span class="p">()</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>                <span class="n">completed_batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">wait_for_rollouts</span><span class="p">(</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                    <span class="n">rollout_ids</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                <span class="p">)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="k">for</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="n">completed_batch</span><span class="p">:</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>                <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">:</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>                    <span class="c1"># Already processed, skip</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rollout</span><span class="p">,</span> <span class="n">Rollout</span><span class="p">):</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                    <span class="n">rollout</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data_v1</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">:</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Received unknown rollout ID </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">[</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rollout</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span><span class="si">}</span><span class="s2"> tasks...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All tasks finished.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_until_all_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronously waits for all queued tasks to be completed and reported.&quot;&quot;&quot;</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No tasks were queued.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>            <span class="k">return</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>            <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>            <span class="k">assert</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>        <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_run_until_finished</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait indefinitely for all tasks to complete</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while waiting for tasks to finish: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>            <span class="k">raise</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_test_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates and returns metrics for a validation run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during validation.&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="n">sample_stat_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">sample_stat_list_by_source</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="nb">list</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>        <span class="p">)</span>  <span class="c1"># FIXME: Evaluate whether grouping stats by source is actually needed.</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No triplets found for test rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>                <span class="n">sample_stat_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">})</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>                <span class="k">continue</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="n">response_length_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">]</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="k">if</span> <span class="s2">&quot;data_source&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]:</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>                <span class="c1"># When a test sample includes a &#39;data_source&#39; field, record per-source statistics for test results.</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">][</span><span class="s2">&quot;data_source&quot;</span><span class="p">]</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                <span class="n">sample_stat_list_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                    <span class="p">{</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                        <span class="s2">&quot;sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">),</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                        <span class="s2">&quot;mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_length_list</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                        <span class="s2">&quot;turn_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">),</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                        <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                    <span class="p">}</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="p">)</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>            <span class="n">sample_stat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                <span class="p">{</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                    <span class="s2">&quot;sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">),</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                    <span class="s2">&quot;mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_length_list</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                    <span class="s2">&quot;turn_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">),</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                    <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                <span class="p">}</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>            <span class="p">)</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>        <span class="n">metric_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>        <span class="n">stats_w_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span> <span class="k">if</span> <span class="s2">&quot;sum_response_length&quot;</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>        <span class="n">stats_w_trace_by_source</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="n">data_source</span><span class="p">:</span> <span class="p">[</span><span class="n">stat</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stats</span> <span class="k">if</span> <span class="s2">&quot;sum_response_length&quot;</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>            <span class="k">for</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="ow">in</span> <span class="n">sample_stat_list_by_source</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>        <span class="p">}</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>        <span class="k">for</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="ow">in</span> <span class="n">sample_stat_list_by_source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="n">metric_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>                <span class="p">{</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                    <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/n_rollouts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">),</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                    <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/n_rollouts_w_trace&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]),</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                    <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                        <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stats</span><span class="p">]</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                    <span class="p">),</span>  <span class="c1"># each rollout must have a reward (fillna if missing)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                    <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                        <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;mean_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]]</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                    <span class="p">),</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                    <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                        <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;sum_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]]</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                    <span class="p">),</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                    <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/turn_count&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                        <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;turn_count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]]</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                    <span class="p">),</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                <span class="p">}</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>            <span class="p">)</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="n">metric_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>            <span class="p">{</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>                <span class="s2">&quot;val/n_rollouts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_stat_list</span><span class="p">),</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                <span class="s2">&quot;val/n_rollouts_w_trace&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_w_trace</span><span class="p">),</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                <span class="s2">&quot;val/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                    <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                <span class="p">),</span>  <span class="c1"># each rollout must have a reward (fillna if missing)</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                <span class="s2">&quot;val/mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;mean_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace</span><span class="p">]),</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                <span class="s2">&quot;val/sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;sum_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace</span><span class="p">]),</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                <span class="s2">&quot;val/turn_count&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;turn_count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace</span><span class="p">]),</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>            <span class="p">}</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>        <span class="p">)</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>        <span class="k">return</span> <span class="n">metric_dict</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_train_data_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">        Processes completed rollouts to generate a training data batch.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">        This function reconstructs the logic from the original AgentModeDaemon,</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">        using data retrieved from the new server architecture. It handles padding,</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">        truncation, and tensor creation for the PPO training loop.</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during training.&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>        <span class="c1"># 1. Reconstruct the `finished_id_to_sample_info` structure from completed rollouts</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>        <span class="n">finished_id_to_sample_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="n">finished_id_to_final_reward</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>            <span class="n">original_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>            <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                <span class="n">finished_id_to_final_reward</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_reward</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No triplets found for training rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>                <span class="k">continue</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>            <span class="c1"># The client should report triplets that contain prompt_ids and response_ids.</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>            <span class="c1"># Example triplet.prompt: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>            <span class="c1"># Example triplet.response: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>            <span class="n">trace_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>                <span class="p">{</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="s2">&quot;response_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])}</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>            <span class="p">]</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>                <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>                <span class="s2">&quot;trace_list&quot;</span><span class="p">:</span> <span class="n">trace_list</span><span class="p">,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>                <span class="s2">&quot;data_id&quot;</span><span class="p">:</span> <span class="n">original_sample</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>            <span class="p">}</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>            <span class="n">finished_id_to_sample_info</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>            <span class="n">finished_id_to_final_reward</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_reward</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>        <span class="c1">#</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>        <span class="c1"># --- Data processing and tensor creation logic ---</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>        <span class="c1"># Get all the reported data.</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="c1"># prompt_ids are left-padded.</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>        <span class="c1"># response_ids are right-padded.</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>        <span class="c1"># They are concatenated in the middle.</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>        <span class="c1"># Discard handling:</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>        <span class="c1">#   - Those exceeding max_prompt_length will be marked for discard, but not</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>        <span class="c1">#     discarded here. They are only truncated and marked, to be discarded later.</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>        <span class="c1">#     This is for the correctness of the advantage calculation.</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>        <span class="c1">#   - The discard for the PPO mini-batch should also be handled this way.</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="n">input_ids_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>        <span class="n">input_attention_mask_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="n">response_ids_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>        <span class="n">response_attention_mask_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>        <span class="n">reward_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>        <span class="n">data_id_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>        <span class="n">rollout_id_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>        <span class="n">turn_index_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="n">is_drop_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>        <span class="n">n_trunc_sample_because_of_response</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">sample_info</span> <span class="ow">in</span> <span class="n">finished_id_to_sample_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>            <span class="k">for</span> <span class="n">turn_index</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;trace_list&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>                <span class="n">reward_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">])</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>                <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">response_ids</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;response_ids&quot;</span><span class="p">]</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>                <span class="c1"># Mark samples with prompts exceeding max_prompt_length to be dropped later</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_prompt_length</span><span class="p">:</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>                    <span class="n">prompt_ids</span> <span class="o">=</span> <span class="n">prompt_ids</span><span class="p">[:</span><span class="n">max_prompt_length</span><span class="p">]</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>                    <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>                    <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>                <span class="c1"># Truncate responses that exceed max_response_length</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_response_length</span><span class="p">:</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>                    <span class="n">response_ids</span> <span class="o">=</span> <span class="n">response_ids</span><span class="p">[:</span><span class="n">max_response_length</span><span class="p">]</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>                    <span class="n">n_trunc_sample_because_of_response</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>                <span class="c1"># Pad prompts to the left and responses to the right</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>                <span class="n">one_input_ids</span><span class="p">,</span> <span class="n">one_input_attention_mask</span> <span class="o">=</span> <span class="n">get_left_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>                    <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>                <span class="p">)</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>                <span class="n">one_response_ids</span><span class="p">,</span> <span class="n">one_response_attention_mask</span> <span class="o">=</span> <span class="n">get_right_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>                    <span class="n">response_ids</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>                <span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>                <span class="n">input_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_ids</span><span class="p">)</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>                <span class="n">input_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>                <span class="n">response_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_ids</span><span class="p">)</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>                <span class="n">response_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>                <span class="n">data_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>                <span class="n">rollout_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>                <span class="n">turn_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_index</span><span class="p">)</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>        <span class="n">n_transition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>        <span class="n">batch_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>        <span class="n">input_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>        <span class="n">batch_response_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>        <span class="n">response_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>        <span class="c1"># Concatenate prompts and responses to form the full sequence</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>        <span class="n">batch_seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_input_ids</span><span class="p">,</span> <span class="n">batch_response_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_attention_mask</span><span class="p">,</span> <span class="n">response_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>        <span class="n">position_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>        <span class="n">is_drop_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">is_drop_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reward_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>        <span class="c1"># Create token-level scores by placing the final reward at the last token position</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>        <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>        <span class="c1"># At the eos_mask_idx position of each sample, fill in the corresponding scores.</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>        <span class="c1"># torch.arange(n_transition) generates [0,1,2,...,bsz-1] as indices for the batch dimension.</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>        <span class="n">eos_mask_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">position_ids</span> <span class="o">*</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (bsz,)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>        <span class="n">token_level_scores</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_transition</span><span class="p">),</span> <span class="n">eos_mask_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>        <span class="c1"># Only take the last response_length part of the sequence to get the token-level scores for the model&#39;s response part.</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>        <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">token_level_scores</span><span class="p">[:,</span> <span class="o">-</span><span class="n">max_response_length</span><span class="p">:]</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="c1"># Form the final batch using TensorDict</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="n">TensorDict</span><span class="p">(</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>            <span class="p">{</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>                <span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">batch_input_ids</span><span class="p">,</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>                <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">batch_response_ids</span><span class="p">,</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>                <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">batch_seq</span><span class="p">,</span>  <span class="c1"># here input_ids become the whole sentences</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>                <span class="s2">&quot;position_ids&quot;</span><span class="p">:</span> <span class="n">position_ids</span><span class="p">,</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>                <span class="s2">&quot;is_drop_mask&quot;</span><span class="p">:</span> <span class="n">is_drop_mask</span><span class="p">,</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>                <span class="s2">&quot;token_level_scores&quot;</span><span class="p">:</span> <span class="n">token_level_scores</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>            <span class="p">},</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>        <span class="p">)</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>        <span class="n">data_proto</span> <span class="o">=</span> <span class="n">DataProto</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>        <span class="n">data_metrics</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>            <span class="s2">&quot;training/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">finished_id_to_final_reward</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>            <span class="s2">&quot;training/n_rollouts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_id_to_final_reward</span><span class="p">),</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>            <span class="s2">&quot;training/n_rollouts_w_trace&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_id_to_sample_info</span><span class="p">),</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>            <span class="s2">&quot;training/n_truncated_triplets&quot;</span><span class="p">:</span> <span class="n">n_trunc_sample_because_of_response</span><span class="p">,</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>            <span class="s2">&quot;training/n_triplets&quot;</span><span class="p">:</span> <span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="p">}</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>        <span class="c1"># Add non-tensor data for advantage calculation and logging</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>        <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;data_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_id_list</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>        <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;rollout_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rollout_id_list</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>        <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;turn_index_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">turn_index_list</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>        <span class="k">return</span> <span class="n">data_proto</span><span class="p">,</span> <span class="n">data_metrics</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets the internal state of the daemon for the next run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>        <span class="c1"># For a true reset, the server&#39;s internal queues would also need clearing.</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>        <span class="c1"># This implementation assumes that `set_up_data_and_server` is called</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>        <span class="c1"># for each new run, effectively starting a fresh batch.</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fillna_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout</span><span class="p">:</span> <span class="n">RolloutLegacy</span><span class="p">):</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">final_reward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>                <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward is None for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, please check the reward function.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>            <span class="n">final_reward</span> <span class="o">=</span> <span class="n">rollout</span><span class="o">.</span><span class="n">final_reward</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="k">return</span> <span class="n">final_reward</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">clear_data_and_server</span><span class="p">()</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Resets the internal state of the daemon for the next run.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="k">def</span><span class="w"> </span><span class="nf">clear_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Resets the internal state of the daemon for the next run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.get_test_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_test_metrics</span><span class="p">()</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.get_test_metrics" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Calculates and returns metrics for a validation run.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_test_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates and returns metrics for a validation run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during validation.&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>    <span class="n">sample_stat_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>    <span class="n">sample_stat_list_by_source</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="nb">list</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>    <span class="p">)</span>  <span class="c1"># FIXME: Evaluate whether grouping stats by source is actually needed.</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>    <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No triplets found for test rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>            <span class="n">sample_stat_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">})</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>            <span class="k">continue</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">response_length_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">]</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="k">if</span> <span class="s2">&quot;data_source&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]:</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="c1"># When a test sample includes a &#39;data_source&#39; field, record per-source statistics for test results.</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>            <span class="n">data_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">][</span><span class="s2">&quot;data_source&quot;</span><span class="p">]</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>            <span class="n">sample_stat_list_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                <span class="p">{</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                    <span class="s2">&quot;sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">),</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                    <span class="s2">&quot;mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_length_list</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                    <span class="s2">&quot;turn_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">),</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                    <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                <span class="p">}</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>            <span class="p">)</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>        <span class="n">sample_stat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>            <span class="p">{</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                <span class="s2">&quot;sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">),</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                <span class="s2">&quot;mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_length_list</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                <span class="s2">&quot;turn_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">),</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>            <span class="p">}</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>        <span class="p">)</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>    <span class="n">metric_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>    <span class="n">stats_w_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span> <span class="k">if</span> <span class="s2">&quot;sum_response_length&quot;</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>    <span class="n">stats_w_trace_by_source</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>        <span class="n">data_source</span><span class="p">:</span> <span class="p">[</span><span class="n">stat</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stats</span> <span class="k">if</span> <span class="s2">&quot;sum_response_length&quot;</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">]</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="k">for</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="ow">in</span> <span class="n">sample_stat_list_by_source</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>    <span class="p">}</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>    <span class="k">for</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="ow">in</span> <span class="n">sample_stat_list_by_source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>        <span class="n">metric_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="p">{</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>                <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/n_rollouts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">),</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/n_rollouts_w_trace&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]),</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                    <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stats</span><span class="p">]</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                <span class="p">),</span>  <span class="c1"># each rollout must have a reward (fillna if missing)</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                    <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;mean_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]]</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="p">),</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                    <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;sum_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]]</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                <span class="p">),</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                <span class="sa">f</span><span class="s2">&quot;val/</span><span class="si">{</span><span class="n">data_source</span><span class="si">}</span><span class="s2">/turn_count&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                    <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;turn_count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace_by_source</span><span class="p">[</span><span class="n">data_source</span><span class="p">]]</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                <span class="p">),</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>            <span class="p">}</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="p">)</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>    <span class="n">metric_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>        <span class="p">{</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>            <span class="s2">&quot;val/n_rollouts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_stat_list</span><span class="p">),</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="s2">&quot;val/n_rollouts_w_trace&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_w_trace</span><span class="p">),</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>            <span class="s2">&quot;val/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>            <span class="p">),</span>  <span class="c1"># each rollout must have a reward (fillna if missing)</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>            <span class="s2">&quot;val/mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;mean_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace</span><span class="p">]),</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>            <span class="s2">&quot;val/sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;sum_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace</span><span class="p">]),</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>            <span class="s2">&quot;val/turn_count&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;turn_count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_w_trace</span><span class="p">]),</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>        <span class="p">}</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>    <span class="p">)</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>    <span class="k">return</span> <span class="n">metric_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_train_data_batch</span><span class="p">(</span><span class="n">max_prompt_length</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Processes completed rollouts to generate a training data batch.</p>
<p>This function reconstructs the logic from the original AgentModeDaemon,
using data retrieved from the new server architecture. It handles padding,
truncation, and tensor creation for the PPO training loop.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-632" name="__codelineno-0-632"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_train_data_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a><span class="sd">    Processes completed rollouts to generate a training data batch.</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a><span class="sd">    This function reconstructs the logic from the original AgentModeDaemon,</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a><span class="sd">    using data retrieved from the new server architecture. It handles padding,</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a><span class="sd">    truncation, and tensor creation for the PPO training loop.</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during training.&quot;</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>    <span class="c1"># 1. Reconstruct the `finished_id_to_sample_info` structure from completed rollouts</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>    <span class="n">finished_id_to_sample_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>    <span class="n">finished_id_to_final_reward</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>    <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts_v0</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>        <span class="n">original_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>        <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>            <span class="n">finished_id_to_final_reward</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_reward</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No triplets found for training rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>            <span class="k">continue</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>        <span class="c1"># The client should report triplets that contain prompt_ids and response_ids.</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>        <span class="c1"># Example triplet.prompt: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>        <span class="c1"># Example triplet.response: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>        <span class="n">trace_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>            <span class="p">{</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="s2">&quot;response_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])}</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>        <span class="p">]</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>            <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>            <span class="s2">&quot;trace_list&quot;</span><span class="p">:</span> <span class="n">trace_list</span><span class="p">,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>            <span class="s2">&quot;data_id&quot;</span><span class="p">:</span> <span class="n">original_sample</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>        <span class="p">}</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>        <span class="n">finished_id_to_sample_info</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="n">finished_id_to_final_reward</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_reward</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>    <span class="c1">#</span>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>    <span class="c1"># --- Data processing and tensor creation logic ---</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>    <span class="c1"># Get all the reported data.</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>    <span class="c1"># prompt_ids are left-padded.</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>    <span class="c1"># response_ids are right-padded.</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>    <span class="c1"># They are concatenated in the middle.</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>    <span class="c1"># Discard handling:</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>    <span class="c1">#   - Those exceeding max_prompt_length will be marked for discard, but not</span>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>    <span class="c1">#     discarded here. They are only truncated and marked, to be discarded later.</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a>    <span class="c1">#     This is for the correctness of the advantage calculation.</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a>    <span class="c1">#   - The discard for the PPO mini-batch should also be handled this way.</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>    <span class="n">input_ids_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>    <span class="n">input_attention_mask_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>    <span class="n">response_ids_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>    <span class="n">response_attention_mask_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>    <span class="n">reward_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>    <span class="n">data_id_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>    <span class="n">rollout_id_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>    <span class="n">turn_index_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>    <span class="n">is_drop_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>    <span class="n">n_trunc_sample_because_of_response</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>    <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">sample_info</span> <span class="ow">in</span> <span class="n">finished_id_to_sample_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>        <span class="k">for</span> <span class="n">turn_index</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;trace_list&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>            <span class="n">reward_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">])</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>            <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">response_ids</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;response_ids&quot;</span><span class="p">]</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>            <span class="c1"># Mark samples with prompts exceeding max_prompt_length to be dropped later</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_prompt_length</span><span class="p">:</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>                <span class="n">prompt_ids</span> <span class="o">=</span> <span class="n">prompt_ids</span><span class="p">[:</span><span class="n">max_prompt_length</span><span class="p">]</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>                <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>                <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>            <span class="c1"># Truncate responses that exceed max_response_length</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_response_length</span><span class="p">:</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>                <span class="n">response_ids</span> <span class="o">=</span> <span class="n">response_ids</span><span class="p">[:</span><span class="n">max_response_length</span><span class="p">]</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>                <span class="n">n_trunc_sample_because_of_response</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>            <span class="c1"># Pad prompts to the left and responses to the right</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>            <span class="n">one_input_ids</span><span class="p">,</span> <span class="n">one_input_attention_mask</span> <span class="o">=</span> <span class="n">get_left_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>                <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>            <span class="p">)</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>            <span class="n">one_response_ids</span><span class="p">,</span> <span class="n">one_response_attention_mask</span> <span class="o">=</span> <span class="n">get_right_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>                <span class="n">response_ids</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>            <span class="p">)</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>            <span class="n">input_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_ids</span><span class="p">)</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>            <span class="n">input_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>            <span class="n">response_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_ids</span><span class="p">)</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>            <span class="n">response_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>            <span class="n">data_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>            <span class="n">rollout_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>            <span class="n">turn_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_index</span><span class="p">)</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>    <span class="n">n_transition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>    <span class="n">batch_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>    <span class="n">input_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>    <span class="n">batch_response_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>    <span class="n">response_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>    <span class="c1"># Concatenate prompts and responses to form the full sequence</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="n">batch_seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_input_ids</span><span class="p">,</span> <span class="n">batch_response_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>    <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_attention_mask</span><span class="p">,</span> <span class="n">response_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="n">position_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>    <span class="n">is_drop_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">is_drop_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>    <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reward_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a>    <span class="c1"># Create token-level scores by placing the final reward at the last token position</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>    <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>    <span class="c1"># At the eos_mask_idx position of each sample, fill in the corresponding scores.</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a>    <span class="c1"># torch.arange(n_transition) generates [0,1,2,...,bsz-1] as indices for the batch dimension.</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a>    <span class="n">eos_mask_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">position_ids</span> <span class="o">*</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (bsz,)</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a>    <span class="n">token_level_scores</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_transition</span><span class="p">),</span> <span class="n">eos_mask_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a>    <span class="c1"># Only take the last response_length part of the sequence to get the token-level scores for the model&#39;s response part.</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a>    <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">token_level_scores</span><span class="p">[:,</span> <span class="o">-</span><span class="n">max_response_length</span><span class="p">:]</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>    <span class="c1"># Form the final batch using TensorDict</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="n">TensorDict</span><span class="p">(</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="p">{</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>            <span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">batch_input_ids</span><span class="p">,</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>            <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">batch_response_ids</span><span class="p">,</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>            <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">batch_seq</span><span class="p">,</span>  <span class="c1"># here input_ids become the whole sentences</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>            <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>            <span class="s2">&quot;position_ids&quot;</span><span class="p">:</span> <span class="n">position_ids</span><span class="p">,</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>            <span class="s2">&quot;is_drop_mask&quot;</span><span class="p">:</span> <span class="n">is_drop_mask</span><span class="p">,</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>            <span class="s2">&quot;token_level_scores&quot;</span><span class="p">:</span> <span class="n">token_level_scores</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>        <span class="p">},</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>    <span class="p">)</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>    <span class="n">data_proto</span> <span class="o">=</span> <span class="n">DataProto</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>    <span class="n">data_metrics</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>        <span class="s2">&quot;training/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">finished_id_to_final_reward</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="s2">&quot;training/n_rollouts&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_id_to_final_reward</span><span class="p">),</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="s2">&quot;training/n_rollouts_w_trace&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_id_to_sample_info</span><span class="p">),</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>        <span class="s2">&quot;training/n_truncated_triplets&quot;</span><span class="p">:</span> <span class="n">n_trunc_sample_because_of_response</span><span class="p">,</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="s2">&quot;training/n_triplets&quot;</span><span class="p">:</span> <span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>    <span class="p">}</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="c1"># Add non-tensor data for advantage calculation and logging</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>    <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;data_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_id_list</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>    <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;rollout_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rollout_id_list</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>    <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;turn_index_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">turn_index_list</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a>    <span class="k">return</span> <span class="n">data_proto</span><span class="p">,</span> <span class="n">data_metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run_until_all_finished</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Synchronously waits for all queued tasks to be completed and reported.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_until_all_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronously waits for all queued tasks to be completed and reported.&quot;&quot;&quot;</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No tasks were queued.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>        <span class="k">return</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="k">assert</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>    <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_run_until_finished</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>        <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait indefinitely for all tasks to complete</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while waiting for tasks to finish: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_up_data_and_server</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Synchronous wrapper for setting up data and server resources.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_up_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">server_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">is_train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronous wrapper for setting up data and server resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_set_up</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal loop is not running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_loop</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Wait for completion with a timeout</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to set up data on server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.start" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">start</span><span class="p">()</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.start" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Starts the main AgentLightningServer and the proxy server.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Starts the main AgentLightningServer and the proxy server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;v0&quot;</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">run_server</span><span class="p">():</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Run the AgentLightningServer in a separate thread.&quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">run_forever</span><span class="p">())</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="c1"># Wait for the server&#39;s internal startup event to be set.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for AgentLightningServer to start...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>  <span class="c1"># Wait up to 20s</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ready</span><span class="p">:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AgentLightningServer failed to start within the timeout period.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AgentLightningServer control plane running on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_proxy_server_v0</span><span class="p">()</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="c1"># Agent lightning server is no longer needed;</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="c1"># Start proxy server in _async_set_up</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="agentlightning.verl.get_left_padded_ids_and_attention_mask" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">get_left_padded_ids_and_attention_mask</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">)</span></code>

<a href="#agentlightning.verl.get_left_padded_ids_and_attention_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Left-pad (or truncate) a sequence of token IDs to a fixed length,
and build the corresponding attention mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ids</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the original list of token IDs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>desired total length after padding/truncation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pad_token_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID to use for padding.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>padded_ids</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of length == max_length.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>attention_mask</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of same length: 1 for non-pad tokens, 0 for pads.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_left_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Left-pad (or truncate) a sequence of token IDs to a fixed length,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    and build the corresponding attention mask.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        ids:             the original list of token IDs.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        max_length:      desired total length after padding/truncation.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        pad_token_id:    ID to use for padding.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        padded_ids (any):      list of length == max_length.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        attention_mask (any):  list of same length: 1 for non-pad tokens, 0 for pads.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="c1"># too long → truncate from the left, keep the last max_length tokens</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">trimmed</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="o">-</span><span class="n">max_length</span><span class="p">:]</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_length</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="k">return</span> <span class="n">trimmed</span><span class="p">,</span> <span class="n">attention_mask</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="c1"># too short → pad on the left</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">pad_len</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="n">seq_len</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">padded_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span> <span class="o">+</span> <span class="n">ids</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">seq_len</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">return</span> <span class="n">padded_ids</span><span class="p">,</span> <span class="n">attention_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="agentlightning.verl.get_right_padded_ids_and_attention_mask" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">get_right_padded_ids_and_attention_mask</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">)</span></code>

<a href="#agentlightning.verl.get_right_padded_ids_and_attention_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Right-pad (or truncate) a sequence of token IDs to a fixed length,
and build the corresponding attention mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ids</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the original list of token IDs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>desired total length after padding/truncation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pad_token_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID to use for padding.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>padded_ids</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of length == max_length.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>attention_mask</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of same length: 1 for non-pad tokens, 0 for pads.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_right_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    Right-pad (or truncate) a sequence of token IDs to a fixed length,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    and build the corresponding attention mask.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        ids:            the original list of token IDs.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        max_length:     desired total length after padding/truncation.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        pad_token_id:   ID to use for padding.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        padded_ids (any):     list of length == max_length.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        attention_mask (any): list of same length: 1 for non-pad tokens, 0 for pads.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="c1"># too long → truncate to the first max_length tokens</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">trimmed</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_length</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">return</span> <span class="n">trimmed</span><span class="p">,</span> <span class="n">attention_mask</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="c1"># too short → pad on the right</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">pad_len</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="n">seq_len</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">padded_ids</span> <span class="o">=</span> <span class="n">ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">seq_len</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">return</span> <span class="n">padded_ids</span><span class="p">,</span> <span class="n">attention_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="October 16, 2025 07:01:39 UTC"><span class="timeago" datetime="2025-10-16T07:01:39+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="October 16, 2025 07:01:39 UTC">2025-10-16</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="October 15, 2025 05:37:44 UTC"><span class="timeago" datetime="2025-10-15T05:37:44+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="October 15, 2025 05:37:44 UTC">2025-10-15</span>
  </span>

    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:yuge.zhang@microsoft.com">Yuge Zhang</a>
    </nav>
  </span>

    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
  
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
    
  <script>
    // Show warning banner if not viewing stable documentation
    document.addEventListener("DOMContentLoaded", function() {
      const currentURL = window.location.href;
      const warningDiv = document.getElementById("version-warning");

      // Check if we're on the stable docs or the redirect page
      if (currentURL.includes('agent-lightning/latest/')) {
        // Show warning for explicitly latest docs
        warningDiv.style.display = "block";
      }
    });
  </script>

  </body>
</html>